name: Deploy to Aliyun Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Dependencies (Local)
      run: npm ci

    - name: Build Project
      run: |
        npm run build
      env:
        NEXT_TELEMETRY_DISABLED: 1

    - name: Prepare Standalone Artifacts
      run: |
        echo "ðŸ“¦ Preparing standalone folder..."
        
        # 1. Copy package-lock.json (Correct dependency versions)
        cp package-lock.json .next/standalone/
        
        # 2. Copy static assets (Crucial for styles/images)
        mkdir -p .next/standalone/.next/static
        cp -r .next/static .next/standalone/.next/
        
        # 3. Copy public folder
        cp -r public .next/standalone/

        # 4. Remove node_modules (We will install Linux-compatible deps on server)
        # This drastically reduces zip size and uploads speed
        rm -rf .next/standalone/node_modules
        
        echo "âœ… Standalone folder prepared."

    - name: Create Deployment Archive
      run: |
        # Zip the standalone folder and other root configs
        zip -r deploy.zip .next/standalone ecosystem.config.js package.json
        
        # Include .env.production if it exists in the repo (or create it from secrets if preferred)
        if [ -f .env.production ]; then
          zip -u deploy.zip .env.production
        fi
        
        echo "ðŸ“¦ Zip created:"
        ls -lh deploy.zip

    - name: Upload to Server via SCP
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        # password: ${{ secrets.SERVER_PASSWORD }} # Use this if SSH key is not configured
        source: "deploy.zip"
        target: "/var/www/dabo_personal"

    - name: Deploy on Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        # password: ${{ secrets.SERVER_PASSWORD }} # Use this if SSH key is not configured
        script: |
          set -e
          cd /var/www/dabo_personal
          
          echo "ðŸ“¦ Unzipping artifact..."
          unzip -o deploy.zip
          
          echo "ðŸ“¥ Installing production dependencies..."
          cd .next/standalone
          npm install --production
          cd ../..
          
          echo "ðŸ”„ Restarting application..."
          pm2 restart dabo-personal
          
          echo "âœ… Deployment complete!"
