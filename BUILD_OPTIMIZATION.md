# 构建优化和问题排查

## 🔍 5分钟卡住的可能原因

### 1. 服务器资源不足（最可能）

**症状：**
- 构建过程卡住，没有输出
- 服务器内存或 CPU 不足

**检查方法：**
- 查看 GitHub Actions 日志中的资源检查输出
- 检查是否有内存不足的错误

**解决方案：**
- 已添加资源检查
- 已设置 Node.js 内存限制（2GB）
- 如果内存不足，考虑升级服务器配置

### 2. 构建过程挂起

**可能原因：**
- TypeScript 编译卡住
- 图片优化卡住
- 静态页面生成卡住

**解决方案：**
- 已优化构建配置
- 已添加实时输出
- 已减少静态页面生成（从 32 个减少到 14 个）

### 3. 网络问题

**症状：**
- SSH 连接延迟
- 输出延迟

**解决方案：**
- 已添加实时输出（stdbuf）
- 已添加超时保护

## 🚀 已做的优化

### 1. 减少静态页面生成
- ✅ `forum/[id]` 改为动态渲染（减少 18 个页面）
- ✅ 预计构建时间：2-4 分钟

### 2. 优化构建配置
- ✅ 设置 Node.js 内存限制
- ✅ 优化包导入
- ✅ 添加资源检查

### 3. 改进输出
- ✅ 实时构建输出
- ✅ 详细的错误诊断
- ✅ 资源使用情况显示

## 💡 如果仍然卡住

### 方案 1: 检查服务器资源

通过阿里云控制台 Web SSH 登录服务器：

```bash
# 检查内存
free -h

# 检查磁盘
df -h

# 检查 CPU
top

# 检查是否有构建进程
ps aux | grep -E "node|next|build"
```

### 方案 2: 使用本地构建（推荐）

如果服务器资源不足，使用本地构建：

```bash
# 1. 本地构建
npm run build:local

# 2. 部署构建产物（如果 SSH 可用）
npm run deploy:build
```

### 方案 3: 升级服务器配置

如果服务器资源确实不足：
- 增加内存（推荐至少 2GB）
- 增加 CPU 核心数
- 使用 SSD 存储

## 📊 构建时间对比

| 配置 | 静态页面数 | 预计时间 |
|------|-----------|---------|
| 优化前 | 32 个 | 6-10 分钟 |
| 优化后 | 14 个 | 2-4 分钟 |

## 🔧 下一步

1. **等待当前部署完成**（最多 20 分钟）
2. **查看优化后的日志**（会显示资源使用情况）
3. **如果仍然慢**，考虑使用本地构建方案
